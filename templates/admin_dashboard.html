{% extends 'base.html' %}
{% block title %}Admin Dashboard - Hospital Management System{% endblock %}
{% block content %}
<div class="page-header">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h3><i class="bi bi-speedometer2 me-2"></i>Admin Dashboard</h3>
      <p class="text-muted mb-0">Manage your hospital system</p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-success" href="{{ url_for('create_doctor') }}">
        <i class="bi bi-person-plus me-2"></i>Add Doctor
      </a>
      <a class="btn btn-outline-primary" href="{{ url_for('admin_search') }}">
        <i class="bi bi-search me-2"></i>Search
      </a>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card stats-card">
      <div class="card-body text-center">
        <i class="bi bi-person-badge text-primary" style="font-size: 2rem;"></i>
        <h4 class="mt-2 mb-0">{{ total_doctors }}</h4>
        <p class="text-muted mb-0">Total Doctors</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stats-card">
      <div class="card-body text-center">
        <i class="bi bi-people text-success" style="font-size: 2rem;"></i>
        <h4 class="mt-2 mb-0">{{ total_patients }}</h4>
        <p class="text-muted mb-0">Total Patients</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stats-card">
      <div class="card-body text-center">
        <i class="bi bi-calendar-check text-info" style="font-size: 2rem;"></i>
        <h4 class="mt-2 mb-0">{{ total_appointments }}</h4>
        <p class="text-muted mb-0">Total Appointments</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card stats-card">
      <div class="card-body text-center">
        <i class="bi bi-graph-up text-warning" style="font-size: 2rem;"></i>
        <h4 class="mt-2 mb-0">{{ total_appointments|default(0) }}</h4>
        <p class="text-muted mb-0">System Health</p>
      </div>
    </div>
  </div>
</div>

<!-- Registered Doctors Section -->
<div class="content-area mb-4">
  <h5 class="mb-3">
    <i class="bi bi-person-badge me-2"></i>Registered Doctors
  </h5>
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th><i class="bi bi-hash me-1"></i>S.No</th>
          <th><i class="bi bi-person me-1"></i>Doctor Name</th>
          <th><i class="bi bi-mortarboard me-1"></i>Professional Domain</th>
          <th><i class="bi bi-building me-1"></i>Department</th>
          <th><i class="bi bi-flag me-1"></i>Status</th>
          <th><i class="bi bi-gear me-1"></i>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for d in doctors %}
          <tr>
            <td><span class="badge bg-secondary">{{ loop.index }}</span></td>
            <td>
              <div class="d-flex align-items-center">
                <i class="bi bi-person-badge me-2 text-success"></i>
                <strong>{{ d.user.full_name }}</strong>
              </div>
            </td>
            <td>{{ d.specialization }}</td>
            <td>{{ d.department.name if d.department else 'General Practice' }}</td>
            <td>
              <span class="badge bg-{% if d.user.active %}success{% else %}danger{% endif %}">
                {{ 'Active' if d.user.active else 'Blacklisted' }}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary"
                        title="Edit Doctor"
                        data-id="{{ d.id }}"
                        data-fullname="{{ d.user.full_name }}"
                        data-username="{{ d.user.username }}"
                        data-specialization="{{ d.specialization }}"
                        data-department-id="{{ d.department.id if d.department else '' }}"
                        onclick="openEditDoctorModal(this)">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" title="Delete Doctor" onclick="deleteDoctor({{ d.id }})">
                  <i class="bi bi-trash"></i>
                </button>
                <form method="post" action="{{ url_for('admin_toggle_active', user_id=d.user.id) }}" class="d-inline">
                  <button class="btn btn-outline-{% if d.user.active %}warning{% else %}success{% endif %}" title="{% if d.user.active %}Blacklist{% else %}Activate{% endif %} Doctor">
                    <i class="bi bi-{% if d.user.active %}person-x{% else %}person-check{% endif %}"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">
              <i class="bi bi-person-x" style="font-size: 2rem;"></i>
              <p class="mt-2 mb-0">No doctors registered</p>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Registered Patients Section -->
<div class="content-area mb-4">
  <h5 class="mb-3">
    <i class="bi bi-people me-2"></i>Registered Patients
  </h5>
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th><i class="bi bi-hash me-1"></i>S.No</th>
          <th><i class="bi bi-person me-1"></i>Patient Name</th>
          <th><i class="bi bi-at me-1"></i>Username</th>
          <th><i class="bi bi-calendar me-1"></i>Registration Date</th>
          <th><i class="bi bi-flag me-1"></i>Status</th>
          <th><i class="bi bi-gear me-1"></i>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for p in patients %}
          <tr>
            <td><span class="badge bg-secondary">{{ loop.index }}</span></td>
            <td>
              <div class="d-flex align-items-center">
                <i class="bi bi-person-heart me-2 text-primary"></i>
                <strong>{{ p.user.full_name }}</strong>
              </div>
            </td>
            <td>{{ p.user.username }}</td>
            <td>N/A</td>
            <td>
              <span class="badge bg-{% if p.user.active %}success{% else %}danger{% endif %}">
                {{ 'Active' if p.user.active else 'Blacklisted' }}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary"
                        title="Edit Patient"
                        data-id="{{ p.id }}"
                        data-fullname="{{ p.user.full_name }}"
                        data-username="{{ p.user.username }}"
                        data-age="{{ p.age or '' }}"
                        data-medical-info="{{ (p.medical_info or '')|e }}"
                        onclick="openEditPatientModal(this)">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" title="Delete Patient" onclick="deletePatient({{ p.id }})">
                  <i class="bi bi-trash"></i>
                </button>
                <form method="post" action="{{ url_for('admin_toggle_active', user_id=p.user.id) }}" class="d-inline">
                  <button class="btn btn-outline-{% if p.user.active %}warning{% else %}success{% endif %}" title="{% if p.user.active %}Blacklist{% else %}Activate{% endif %} Patient">
                    <i class="bi bi-{% if p.user.active %}person-x{% else %}person-check{% endif %}"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">
              <i class="bi bi-people" style="font-size: 2rem;"></i>
              <p class="mt-2 mb-0">No patients registered</p>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Upcoming Appointments Section -->
<div class="content-area">
  <h5 class="mb-3">
    <i class="bi bi-calendar-event me-2"></i>Upcoming Appointments
  </h5>
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th><i class="bi bi-hash me-1"></i>S.No</th>
          <th><i class="bi bi-person me-1"></i>Patient Name</th>
          <th><i class="bi bi-person-badge me-1"></i>Doctor Name</th>
          <th><i class="bi bi-building me-1"></i>Department</th>
          <th><i class="bi bi-calendar me-1"></i>Date</th>
          <th><i class="bi bi-clock me-1"></i>Time</th>
          <th><i class="bi bi-clock-history me-1"></i>Patient History</th>
          <th><i class="bi bi-flag me-1"></i>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for a in appointments %}
          <tr>
            <td><span class="badge bg-secondary">{{ loop.index }}</span></td>
            <td>
              <div class="d-flex align-items-center">
                <i class="bi bi-person-heart me-2 text-primary"></i>
                {{ a.patient.user.full_name }}
              </div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <i class="bi bi-person-badge me-2 text-success"></i>
                {{ a.doctor.user.full_name }}
              </div>
            </td>
            <td>{{ a.doctor.department.name if a.doctor.department else 'General Practice' }}</td>
            <td>{{ a.date }}</td>
            <td><span class="badge bg-light text-dark">{{ a.time }}</span></td>
            <td>
              <button class="btn btn-outline-info btn-sm" onclick="viewPatientHistory({{ a.patient.id }}, '{{ a.patient.user.full_name }}', '{{ a.doctor.user.full_name }}', '{{ a.doctor.department.name if a.doctor.department else 'General Practice' }}')">
                <i class="bi bi-eye me-1"></i>View
              </button>
            </td>
            <td>
              <span class="badge bg-{% if a.status == 'Completed' %}success{% elif a.status == 'Cancelled' %}danger{% else %}primary{% endif %}">
                {{ a.status }}
              </span>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
              <p class="mt-2 mb-0">No appointments found</p>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Patient History Modal -->
<div class="modal fade" id="patientHistoryModal" tabindex="-1" aria-labelledby="patientHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="patientHistoryModalLabel">
          <i class="bi bi-clock-history me-2"></i>Patient History
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <i class="bi bi-person-heart text-primary" style="font-size: 3rem;"></i>
                <h6 class="mt-2 mb-1" id="modalPatientName">Patient Name</h6>
                <small class="text-muted">Patient</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <i class="bi bi-person-badge text-success" style="font-size: 3rem;"></i>
                <h6 class="mt-2 mb-1" id="modalDoctorName">Doctor Name</h6>
                <small class="text-muted">Treating Doctor</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <i class="bi bi-building text-info" style="font-size: 3rem;"></i>
                <h6 class="mt-2 mb-1" id="modalDepartment">Department</h6>
                <small class="text-muted">Medical Department</small>
              </div>
            </div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th><i class="bi bi-hash me-1"></i>S.No</th>
                <th><i class="bi bi-calendar-check me-1"></i>Visit Type</th>
                <th><i class="bi bi-clipboard-check me-1"></i>Tests Done</th>
                <th><i class="bi bi-clipboard-pulse me-1"></i>Diagnosis</th>
                <th><i class="bi bi-capsule me-1"></i>Prescription</th>
                <th><i class="bi bi-pill me-1"></i>Medicines Name</th>
                <th><i class="bi bi-calendar me-1"></i>Date</th>
              </tr>
            </thead>
            <tbody id="patientHistoryTableBody">
              <!-- Patient history data will be loaded here -->
            </tbody>
          </table>
        </div>
        
        <div id="noHistoryMessage" class="text-center py-4" style="display: none;">
          <i class="bi bi-clipboard-x text-muted" style="font-size: 3rem;"></i>
          <h5 class="text-muted mt-3">No Medical History Found</h5>
          <p class="text-muted">This patient doesn't have any recorded medical history yet.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Doctor Modal -->
<div class="modal fade" id="editDoctorModal" tabindex="-1" aria-labelledby="editDoctorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDoctorModalLabel"><i class="bi bi-pencil-square me-2"></i>Edit Doctor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="editDoctorForm" action="{{ url_for('admin_edit_doctor_post') }}">
        <div class="modal-body">
          <input type="hidden" id="editDoctorId" name="_id">
          <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input class="form-control" id="editDoctorFullName" name="full_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input class="form-control" id="editDoctorUsername" name="username" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Professional Domain</label>
            <input class="form-control" id="editDoctorSpecialization" name="specialization">
          </div>
          <div class="mb-0">
            <label class="form-label">Department</label>
            <select class="form-select" id="editDoctorDepartment" name="department_id">
              <option value="">-- Select Department --</option>
              {% for dept in departments %}
                <option value="{{ dept.id }}">{{ dept.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
  
</div>

<!-- Edit Patient Modal -->
<div class="modal fade" id="editPatientModal" tabindex="-1" aria-labelledby="editPatientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPatientModalLabel"><i class="bi bi-pencil-square me-2"></i>Edit Patient</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="editPatientForm" action="{{ url_for('admin_edit_patient_post') }}">
        <div class="modal-body">
          <input type="hidden" id="editPatientId" name="_id">
          <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input class="form-control" id="editPatientFullName" name="full_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input class="form-control" id="editPatientUsername" name="username" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Age</label>
            <input class="form-control" id="editPatientAge" name="age" type="number" min="0">
          </div>
          <div class="mb-0">
            <label class="form-label">Medical Info</label>
            <textarea class="form-control" id="editPatientMedicalInfo" name="medical_info" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Hidden delete forms -->
<form id="deleteDoctorForm" method="post" style="display:none"></form>
<form id="deletePatientForm" method="post" style="display:none"></form>

<script>
// Edit Doctor Modal
function openEditDoctorModal(btn){
  const id = btn.getAttribute('data-id');
  document.getElementById('editDoctorId').value = id;
  document.getElementById('editDoctorFullName').value = btn.getAttribute('data-fullname') || '';
  document.getElementById('editDoctorUsername').value = btn.getAttribute('data-username') || '';
  document.getElementById('editDoctorSpecialization').value = btn.getAttribute('data-specialization') || '';
  document.getElementById('editDoctorDepartment').value = btn.getAttribute('data-department-id') || '';
  const modal = new bootstrap.Modal(document.getElementById('editDoctorModal'));
  modal.show();
}

// Edit Patient Modal
function openEditPatientModal(btn){
  const id = btn.getAttribute('data-id');
  document.getElementById('editPatientId').value = id;
  document.getElementById('editPatientFullName').value = btn.getAttribute('data-fullname') || '';
  document.getElementById('editPatientUsername').value = btn.getAttribute('data-username') || '';
  document.getElementById('editPatientAge').value = btn.getAttribute('data-age') || '';
  document.getElementById('editPatientMedicalInfo').value = btn.getAttribute('data-medical-info') || '';
  const modal = new bootstrap.Modal(document.getElementById('editPatientModal'));
  modal.show();
}
// Patient History Modal Functions
function viewPatientHistory(patientId, patientName, doctorName, department) {
  // Set modal title and patient info
  document.getElementById('modalPatientName').textContent = patientName;
  document.getElementById('modalDoctorName').textContent = doctorName;
  document.getElementById('modalDepartment').textContent = department;
  
  // Clear previous data
  document.getElementById('patientHistoryTableBody').innerHTML = '';
  document.getElementById('noHistoryMessage').style.display = 'none';
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('patientHistoryModal'));
  modal.show();
  
  // Simulate loading patient history (replace with actual API call)
  loadPatientHistory(patientId);
}

async function loadPatientHistory(patientId) {
  const tbody = document.getElementById('patientHistoryTableBody');
  tbody.innerHTML = '';
  
  try {
    const response = await fetch(`{{ url_for('api_patient_history', patient_id=0) }}`.replace('0', patientId));
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Failed to fetch history');
    }
    
    const history = data.history || [];
    
    if (history.length === 0) {
      document.getElementById('noHistoryMessage').style.display = 'block';
      return;
    }
    
    history.forEach((record, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><span class="badge bg-secondary">${index + 1}</span></td>
        <td>${record.visitType || ''}</td>
        <td>${record.testsDone || ''}</td>
        <td>${record.diagnosis || ''}</td>
        <td>${record.prescription || ''}</td>
        <td>${record.medicines || ''}</td>
        <td>${record.date || ''}</td>
      `;
      tbody.appendChild(row);
    });
    
  } catch (error) {
    console.error('Error loading patient history:', error);
    const row = document.createElement('tr');
    row.innerHTML = `
      <td colspan="7" class="text-center text-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Failed to load patient history. Please try again.
      </td>
    `;
    tbody.appendChild(row);
  }
}

// Doctor Management Functions
function deleteDoctor(doctorId) {
  if (confirm('Are you sure you want to delete this doctor? This action cannot be undone.')) {
    const form = document.getElementById('deleteDoctorForm');
    form.action = `{{ url_for('admin_delete_doctor', doctor_id=0) }}`.replace('0', doctorId);
    form.submit();
  }
}

function deletePatient(patientId) {
  if (confirm('Are you sure you want to delete this patient? This action cannot be undone.')) {
    const form = document.getElementById('deletePatientForm');
    form.action = `{{ url_for('admin_delete_patient', patient_id=0) }}`.replace('0', patientId);
    form.submit();
  }
}
</script>
{% endblock %}
